<div class="inventory-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <h1 class="page-title">Inventory Management</h1>
        <p class="page-subtitle">Manage ingredients, quantities, and stock levels</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-primary" (click)="openAddForm()" *ngIf="!showForm">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Add Ingredient
        </button>
        <button class="btn btn-secondary" (click)="loadIngredients()">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M1 4v6h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M23 20v-6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- Low Stock Alert -->
  <div class="alert-section" *ngIf="getLowStockCount() > 0">
    <div class="alert alert-warning">
      <svg class="alert-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 9v4M12 17h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z" stroke="currentColor" stroke-width="2"/>
      </svg>
      <span>{{ getLowStockCount() }} ingredient(s) are running low on stock</span>
    </div>
  </div>

  <!-- Add/Edit Form -->
  <div class="form-section" *ngIf="showForm">
    <div class="form-card">
      <div class="form-header">
        <h2>{{ editingIngredient ? 'Edit Ingredient' : 'Add New Ingredient' }}</h2>
        <button class="close-btn" (click)="cancelEdit()">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      
      <form [formGroup]="ingredientForm" (ngSubmit)="saveIngredient()">
        <div class="form-grid">
          <div class="form-group">
            <label for="name">Name *</label>
            <input 
              type="text" 
              id="name"
              formControlName="name"
              class="form-control"
              placeholder="Enter ingredient name"
            >
            <div class="error-message" *ngIf="ingredientForm.get('name')?.invalid && ingredientForm.get('name')?.touched">
              Name is required and must be at least 2 characters
            </div>
          </div>

          <div class="form-group">
            <label for="quantity">Quantity *</label>
            <input 
              type="number" 
              id="quantity"
              formControlName="quantity"
              class="form-control"
              [placeholder]="isPieceUnit ? '0' : '0.00'"
              [step]="isPieceUnit ? '1' : '0.01'"
              min="0"
            >
            <div class="error-message" *ngIf="ingredientForm.get('quantity')?.invalid && ingredientForm.get('quantity')?.touched">
              <span *ngIf="ingredientForm.get('quantity')?.errors?.['required']">Quantity is required</span>
              <span *ngIf="ingredientForm.get('quantity')?.errors?.['min']">Quantity must be 0 or greater</span>
              <span *ngIf="ingredientForm.get('quantity')?.errors?.['wholeNumber']">Quantity must be a whole number for pieces</span>
            </div>
          </div>

          <div class="form-group">
            <label for="unit">Unit *</label>
            <select 
              id="unit"
              formControlName="unit"
              class="form-control"
            >
              <option value="">Select unit</option>
              <option *ngFor="let unit of units" [value]="unit">{{ unit }}</option>
            </select>
            <div class="error-message" *ngIf="ingredientForm.get('unit')?.invalid && ingredientForm.get('unit')?.touched">
              Unit is required
            </div>
          </div>

          <div class="form-group">
            <label for="supplier">Supplier</label>
            <input 
              type="text" 
              id="supplier"
              formControlName="supplier"
              class="form-control"
              placeholder="Enter supplier name (optional)"
            >
          </div>

          <div class="form-group">
            <label for="expirationDate">Expiration Date</label>
            <input 
              type="date" 
              id="expirationDate"
              formControlName="expirationDate"
              class="form-control"
            >
          </div>

          <div class="form-group">
            <label for="lowStockThreshold">Low Stock Threshold *</label>
            <input 
              type="number" 
              id="lowStockThreshold"
              formControlName="lowStockThreshold"
              class="form-control"
              [placeholder]="isPieceUnit ? '0' : '0.00'"
              [step]="isPieceUnit ? '1' : '0.01'"
              min="0"
            >
            <div class="error-message" *ngIf="ingredientForm.get('lowStockThreshold')?.invalid && ingredientForm.get('lowStockThreshold')?.touched">
              <span *ngIf="ingredientForm.get('lowStockThreshold')?.errors?.['required']">Low stock threshold is required</span>
              <span *ngIf="ingredientForm.get('lowStockThreshold')?.errors?.['min']">Low stock threshold must be 0 or greater</span>
              <span *ngIf="ingredientForm.get('lowStockThreshold')?.errors?.['wholeNumber']">Low stock threshold must be a whole number for pieces</span>
            </div>
          </div>

          <div class="form-group">
            <label for="unitCost">Unit Cost (₱)</label>
            <input 
              type="number" 
              id="unitCost"
              formControlName="unitCost"
              class="form-control"
              placeholder="0.00"
              step="0.01"
              min="0"
            >
            <div class="error-message" *ngIf="ingredientForm.get('unitCost')?.invalid && ingredientForm.get('unitCost')?.touched">
              <span *ngIf="ingredientForm.get('unitCost')?.errors?.['min']">Unit cost must be 0 or greater</span>
            </div>
          </div>

          <div class="form-group" *ngIf="ingredientForm.get('quantity')?.value && ingredientForm.get('unitCost')?.value">
            <label>Total Value</label>
            <div class="total-value-display">
              ₱{{ totalCost | number:'1.2-2' }}
            </div>
            <small class="form-text">Calculated: Quantity × Unit Cost</small>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="cancelEdit()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="ingredientForm.invalid">
            {{ editingIngredient ? 'Update' : 'Add' }} Ingredient
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Search Section -->
  <div class="filters-section" *ngIf="!showForm">
    <div class="filters-content">
      <div class="search-box">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
          <path d="m21 21-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <input 
          type="text" 
          class="search-input" 
          placeholder="Search ingredients..."
          [(ngModel)]="searchTerm"
          (input)="applyFilter()"
        >
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <p class="loading-text">Loading ingredients...</p>
  </div>

  <!-- Ingredients Table -->
  <div *ngIf="!isLoading && !showForm" class="table-container">
    <div class="table-header">
      <div class="table-info">
        <span class="ingredient-count">{{ filteredIngredients.length }} ingredient(s)</span>
        <span class="table-subtitle">Showing {{ filteredIngredients.length }} of {{ ingredients.length }} total ingredients</span>
      </div>
    </div>

    <div class="table-wrapper">
      <table class="ingredients-table">
        <thead>
          <tr>
            <th>Ingredient</th>
            <th>Quantity</th>
            <th>Unit Cost</th>
            <th>Total Value</th>
            <th>Supplier</th>
            <th>Expiration</th>
            <th>Threshold</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let ingredient of filteredIngredients" [class.low-stock]="isLowStock(ingredient)" (click)="openEditForm(ingredient)" class="clickable-row">
            <td class="name-cell">
              <strong>{{ ingredient.name }}</strong>
            </td>
            <td class="quantity-cell">
              <div class="quantity-info">
                <span class="quantity-amount">
                  {{ (ingredient.unit === 'pcs' || ingredient.unit === 'piece' || ingredient.unit === 'pieces') ? (ingredient.quantity | number:'1.0-0') : (ingredient.quantity | number:'1.2-2') }} {{ ingredient.unit }}
                </span>
                <div class="quantity-controls">
                  <button class="btn-qty btn-qty-minus" (click)="adjustQuantity(ingredient, -1); $event.stopPropagation()" title="Reduce by 1">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                  <button class="btn-qty btn-qty-custom" (click)="openAdjustQuantityDialog(ingredient); $event.stopPropagation()" title="Custom Adjustment">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                  <button class="btn-qty btn-qty-plus" (click)="adjustQuantity(ingredient, 1); $event.stopPropagation()" title="Increase by 1">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                </div>
              </div>
            </td>
            <td class="cost-cell">
              <span *ngIf="ingredient.unitCost">₱{{ ingredient.unitCost | number:'1.2-2' }}</span>
              <span *ngIf="!ingredient.unitCost" class="no-cost">-</span>
            </td>
            <td class="value-cell">
              <span *ngIf="ingredient.unitCost" class="total-value">₱{{ calculateTotalCost(ingredient) | number:'1.2-2' }}</span>
              <span *ngIf="!ingredient.unitCost" class="no-cost">-</span>
            </td>
            <td class="supplier-cell">{{ ingredient.supplier || '-' }}</td>
            <td class="expiration-cell">
              <div class="expiration-info" *ngIf="ingredient.expirationDate; else noExpiration">
                <span [class.expired]="isExpired(ingredient)" [class.expiring-soon]="isExpiringSoon(ingredient)">
                  {{ formatDate(ingredient.expirationDate) }}
                </span>
              </div>
              <ng-template #noExpiration>
                <span class="no-date">-</span>
              </ng-template>
            </td>
            <td class="threshold-cell">
              {{ (ingredient.unit === 'pcs' || ingredient.unit === 'piece' || ingredient.unit === 'pieces') ? (ingredient.lowStockThreshold | number:'1.0-0') : (ingredient.lowStockThreshold | number:'1.2-2') }} {{ ingredient.unit }}
            </td>
            <td class="status-cell">
              <span class="status-badge low-stock-badge" *ngIf="isLowStock(ingredient)">
                Low Stock
              </span>
              <span class="status-badge expired-badge" *ngIf="isExpired(ingredient)">
                Expired
              </span>
              <span class="status-badge expiring-soon-badge" *ngIf="isExpiringSoon(ingredient) && !isExpired(ingredient)">
                Expiring Soon
              </span>
              <span class="status-badge ok-badge" *ngIf="!isLowStock(ingredient) && !isExpired(ingredient) && !isExpiringSoon(ingredient)">
                OK
              </span>
            </td>
            <td class="actions-cell">
              <div class="action-buttons">
                <button class="action-btn edit-btn" (click)="openEditForm(ingredient); $event.stopPropagation()" title="Edit Ingredient">
                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <button class="action-btn delete-btn" (click)="deleteIngredient(ingredient); $event.stopPropagation()" title="Delete Ingredient">
                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Empty State -->
      <div *ngIf="filteredIngredients.length === 0" class="empty-state">
        <svg class="empty-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M20 7h-4M4 7h4m0 0V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m-6 4v6m4-6v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <p class="empty-text">No ingredients found</p>
        <p class="empty-subtext" *ngIf="searchTerm">Try adjusting your search terms</p>
        <button class="btn btn-primary" (click)="openAddForm()" *ngIf="!searchTerm">
          Add Your First Ingredient
        </button>
      </div>
    </div>
  </div>
</div>


